[
  {
    "appcode": "function OnUpdate(doc, meta) {\n    /* Check if further analysis is needed */\n    if (doc.type !== \"transaction\") return;\n    var card = register[\"card:\" + doc.card];\n    if (card.threshold > doc.amount) return;\n    \n    /* Schedule analysis at night (but for workshop: 60s later) */\n    review[doc.txnid] = {\"txnid\": doc.txnid, \"status\": \"open\", \"reason\": \"threshold\"};\n    var tm = new Date();\n    tm.setSeconds(tm.getSeconds() + 15);\n    createTimer(ExtendedVerify, tm, doc.txnid, doc);\n}\n\nfunction ExtendedVerify(doc) {\n    /* Check if user has transacted with this merchant before */\n    var tcard = doc.card;\n    var score = 0;\n    var reasons = {\"product\": false, \"merchant\": false, \"proximity\": false};\n\n    var history =\n        SELECT txnid, product, merchant, city\n        FROM register\n        WHERE\n            type = \"transaction\" AND \n            card = $tcard;\n            \n    for (var txn of history) {\n        if (txn.txnid === doc.txnid) {\n            continue;\n        }\n        /* Check past purchases of this product */\n        if (doc.product === txn.product) {\n            score += 8;\n            reasons[\"product\"] = true;\n        }\n        /* Check interaction with this merchant */\n        if (doc.merchant === txn.merchant) {\n            score += 5;\n            reasons[\"merchant\"] = true;\n        }\n        /* Check locality to city and county */\n        if (doc.city.name === txn.city.name) {\n            score += 2;\n            reasons[\"proximity\"] = true;\n        }\n        if (doc.city.county === txn.city.county) {\n            score += 1;\n            reasons[\"proximity\"] = true;\n        }\n    }\n\n    var status = {\"txnid\": doc.txnid, \"score\": score};\n    for (var key in reasons) {\n        if (!reasons[key]) {\n            status[key] = \"suspected\";\n        } else {\n            status[key] = \"expected\";\n        }\n    }\n\n    if (score > 300) {\n        status[\"disposition\"] = [\"closed\"];\n    }\n    else if (score > 100) {\n        status[\"disposition\"] = [\"human-review\"];\n    }\n    else {\n        status[\"disposition\"] = [\"sms-alert\", \"human-review\"];\n        log(\"Suspicious transaction: \" + doc.txnid)\n    }\n    \n    review[doc.txnid] = status;\n}",
    "depcfg": {
      "buckets": [
        {
          "alias": "review",
          "bucket_name": "review"
        },
        {
          "alias": "register",
          "bucket_name": "register"
        }
      ],
      "metadata_bucket": "meta",
      "source_bucket": "register"
    },
    "version": "evt-6.0.0-0000-ee",
    "handlerid": "9pP6qLfWg8",
    "appname": "verifier",
    "settings": {
      "dcp_stream_boundary": "everything",
      "deployment_status": true,
      "description": "",
      "execution_timeout": 60,
      "log_level": "INFO",
      "processing_status": true,
      "user_prefix": "eventing",
      "worker_count": 3
    }
  }
]
